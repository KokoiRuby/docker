A quickstart of deploying a etcd cluster using [Docker Compose](https://docs.docker.com/compose/) :whale2:

## IP Plan

| Instance | IP            | Port           | HostPort         |
| -------- | ------------- | -------------- | ---------------- |
| etcd0    | 192.168.30.10 | 2379<br />2380 | 16379<br />16380 |
| etcd1    | 192.168.30.11 | 2379<br />2380 | 26379<br />26380 |
| etcd2    | 192.168.30.12 | 2379<br />2380 | 36379<br />36380 |

## Steps

1. Generate certs (Done for u, u can skip to step#2, see more in `./certs`)

   ```bash
   # Install
   $ apt-get -y install golang-cfssl
   
   # Git Clone
   $ git clone https://github.com/etcd-io/etcd.git
   $ cd etcd/hack/tls-setup
   ```

   ```json
   // vim config/req-csr.json
   // Add IPs in hosts field
   {
     "CN": "etcd",
     "hosts": [
       "localhost",
       "127.0.0.1",
       "192.168.30.10",
       "192.168.30.11",
       "192.168.30.12"
     ],
     "key": {
       "algo": "rsa",
       "size": 2048
     },
     "names": [
       {
         "O": "autogenerated",
         "OU": "etcd cluster",
         "L": "the internet"
       }
     ]
   }
   ```

   - (If WSL)

   ```bash
   # Generate key/cert pair
   $ sudo su -
   $ export infra0=192.168.30.10
   $ export infra1=192.168.30.11
   $ export infra2=192.168.30.12
   $ make
   $ exit
   
   # Change ownership
   $ sudo chown $(id -u):$(id -g) certs/*
   
   # Move to /path/to/this/proj/certs
   mv certs/ /mnt/d/CloudNative/Docker/etcd/
   ```

   - (else)

   ```bash
   # Generate key/cert pair
   $ export infra0=192.168.30.10
   $ export infra1=192.168.30.11
   $ export infra2=192.168.30.12
   $ make
   
   # Move to /path/to/this/proj/certs
   $ mv certs/ /mnt/d/CloudNative/Docker/etcd/
   ```

2. Docker Compose Up

   ```bash
   $ docker compose up
   ```

3. Verify

   ```bash
   $ docker exec etcd0 etcdctl \
   --endpoints https://127.0.0.1:2379 \
   --cert /opt/bitnami/etcd/certs/192.168.30.10.pem \
   --key /opt/bitnami/etcd/certs/192.168.30.10-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   member list
   
   $ docker exec etcd0 etcdctl \
   --endpoints https://127.0.0.1:2379 \
   --cert /opt/bitnami/etcd/certs/192.168.30.10.pem \
   --key /opt/bitnami/etcd/certs/192.168.30.10-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   member list -w table
   
   $ docker exec etcd0 etcdctl \
   --endpoints https://127.0.0.1:2379 \
   --cert /opt/bitnami/etcd/certs/192.168.30.10.pem \
   --key /opt/bitnami/etcd/certs/192.168.30.10-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   endpoint status -w table
   
   $ docker exec etcd0 etcdctl \
   --endpoints https://127.0.0.1:2379 \
   --cert /opt/bitnami/etcd/certs/192.168.30.10.pem \
   --key /opt/bitnami/etcd/certs/192.168.30.10-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   endpoint health -w table
   ```

   ```bash
   $ docker exec etcd0 etcdctl \
   --endpoints https://127.0.0.1:2379 \
   --cert /opt/bitnami/etcd/certs/192.168.30.10.pem \
   --key /opt/bitnami/etcd/certs/192.168.30.10-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   put age 18
   
   $ docker exec etcd1 etcdctl \
   --endpoints https://127.0.0.1:2379 \
   --cert /opt/bitnami/etcd/certs/192.168.30.11.pem \
   --key /opt/bitnami/etcd/certs/192.168.30.11-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   get age
   ```

4. Enjoy :smile:

5. (Clean up)

   ```bash
   $ docker compose stop && docker rm -rf etcd1 etcd2 etcd3
   ```

   

   

