A quickstart of deploying a [etcd](https://etcd.io/) cluster with [proxy](https://etcd.io/docs/v2.3/proxy/) using [Docker Compose](https://docs.docker.com/compose/) :whale2:

## IP Plan

| Instance | IP               | Port           | HostPort         |
| -------- | ---------------- | -------------- | ---------------- |
| etcd0    | 192.168.30.10/16 | 2379<br />2380 | 12379<br />12380 |
| etcd1    | 192.168.30.11/16 | 2379<br />2380 | 22379<br />22380 |
| etcd2    | 192.168.30.12/16 | 2379<br />2380 | 32379<br />32380 |
| proxy    | 192.168.30.13/16 | 2379           | 42379            |

## Steps

1. Generate certs (Done already, u may skip to step#2, see more in `./certs`)

   ```bash
   # Install
   $ apt-get -y install golang-cfssl
   ```

   ```json
   // vim config/req-csr.json
   {
     "CN": "etcd",
     "hosts": [
       "localhost",
       "127.0.0.1",
       "192.168.30.10",
       "192.168.30.11",
       "192.168.30.12"
     ],
     "key": {
       "algo": "rsa",
       "size": 2048
     },
     "names": [
       {
         "O": "autogenerated",
         "OU": "etcd cluster",
         "L": "the internet"
       }
     ]
   }
   
   // vim config/proxy-req-csr.json
   {
     "CN": "etcd",
     "hosts": [
       "localhost",
       "127.0.0.1",
       "192.168.30.13"
     ],
     "key": {
       "algo": "rsa",
       "size": 2048
     },
     "names": [
       {
         "O": "autogenerated",
         "OU": "etcd cluster",
         "L": "the internet"
       }
     ]
   }
   ```

   - (If WSL)

   ```bash
   # Generate key/cert pair
   $ cd tls-setup
   $ sudo su -
   $ export infra0=192.168.30.10
   $ export infra1=192.168.30.11
   $ export infra2=192.168.30.12
   $ export proxy=proxy
   $ make
   $ exit
   
   # Change ownership
   $ sudo chown $(id -u):$(id -g) certs/*
   
   # Move corresponding certs to ./certs/[ca|etcd0|etcd1\|etcd2] & ./proxy/certs/[ca|proxy]
   ```

   - (else)

   ```bash
   # Generate key/cert pair
   $ cd tls-setup
   $ export infra0=192.168.30.10
   $ export infra1=192.168.30.11
   $ export infra2=192.168.30.12
   $ export proxy=proxy
   $ make
   
   # Move corresponding certs to ./certs/[ca|etcd0|etcd1\|etcd2] & ./proxy/certs/[ca|proxy]
   ```

2. Create network

   ```bash
   $ docker network create --subnet=192.168.0.0/16 local
   ```

3. Docker Compose Up

   ```bash
   $ docker compose up
   ```

4. Verify

   ```bash
   $ docker exec etcd0 etcdctl \
   --endpoints https://127.0.0.1:2379 \
   --cert /opt/bitnami/etcd/certs/192.168.30.10.pem \
   --key /opt/bitnami/etcd/certs/192.168.30.10-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   member list
   
   $ docker exec etcd0 etcdctl \
   --endpoints https://127.0.0.1:2379 \
   --cert /opt/bitnami/etcd/certs/192.168.30.10.pem \
   --key /opt/bitnami/etcd/certs/192.168.30.10-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   member list -w table
   
   $ docker exec etcd0 etcdctl \
   --endpoints https://127.0.0.1:2379 \
   --cert /opt/bitnami/etcd/certs/192.168.30.10.pem \
   --key /opt/bitnami/etcd/certs/192.168.30.10-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   endpoint status -w table
   
   $ docker exec etcd0 etcdctl \
   --endpoints https://127.0.0.1:2379 \
   --cert /opt/bitnami/etcd/certs/192.168.30.10.pem \
   --key /opt/bitnami/etcd/certs/192.168.30.10-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   endpoint health -w table
   ```

   ```bash
   $ docker exec etcd0 etcdctl \
   --endpoints https://127.0.0.1:2379 \
   --cert /opt/bitnami/etcd/certs/192.168.30.10.pem \
   --key /opt/bitnami/etcd/certs/192.168.30.10-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   put age 18
   
   $ docker exec etcd1 etcdctl \
   --endpoints https://127.0.0.1:2379 \
   --cert /opt/bitnami/etcd/certs/192.168.30.11.pem \
   --key /opt/bitnami/etcd/certs/192.168.30.11-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   get age
   ```

5. Enjoy :smile:

6. (Optinal) Start Proxy

   ```bash
   $ cd proxy && docker compose up
   ```

7. Verify

   ```bash
   $ docker exec proxy etcdctl \
   --endpoints https://192.168.30.10:2379,https://192.168.30.12:2379,https://192.168.30.11:2379 \
   --cert /opt/bitnami/etcd/certs/proxy.pem \
   --key /opt/bitnami/etcd/certs/proxy-key.pem \
   --cacert /opt/bitnami/etcd/certs/ca/ca.pem \
   member list
   ```

8. (Clean up)

   ```bash
   # clean up cluster
   $ docker compose stop && docker rm etcd0 etcd1 etcd2
   
   # clean up proxy
   $ docker compose stop && docker rm proxy
   ```

   

   

