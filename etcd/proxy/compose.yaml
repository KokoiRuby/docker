services:
  etcd_proxy:
    container_name: proxy
    image: 'bitnami/etcd:latest'
    command: "etcd grpc-proxy start --listen-addr=127.0.0.1:2379 --endpoints=https://192.168.30.10:2379,https://192.168.30.11:2379,https://192.168.30.12:2379 --cert /opt/bitnami/etcd/certs/proxy.pem --key /opt/bitnami/etcd/certs/proxy-key.pem --cacert=/opt/bitnami/etcd/certs/ca/ca.pem"
    environment:
      - ALLOW_NONE_AUTHENTICATION=yes
      - ETCD_TRUSTED_CA_FILE=/opt/bitnami/etcd/certs/ca/ca.pem
      - ETCD_CERT_FILE=/opt/bitnami/etcd/certs/proxy.pem
      - ETCD_KEY_FILE=/opt/bitnami/etcd/certs/proxy-key.pem
      - ETCD_PEER_TRUSTED_CA_FILE=/opt/bitnami/etcd/certs/ca/ca.pem
      - ETCD_PEER_CERT_FILE=/opt/bitnami/etcd/certs/peer-proxy.pem
      - ETCD_PEER_KEY_FILE=/opt/bitnami/etcd/certs/peer-proxy-key.pem
      - ETCD_LOG_LEVEL=info
    networks:
      local:
        ipv4_address: 192.168.30.13
    ports:
      - 52379:2379
    volumes:
      - ./data/proxy:/opt/bitnami/etcd/data
      - ./certs/ca:/opt/bitnami/etcd/certs/ca
      - ./certs/proxy:/opt/bitnami/etcd/certs

networks:
  local:
    external: true